{
  "boiler_transitions": [
    { "when": { "from": "regular", "to": "regular" }, "add": ["keep_open_vent"] },
    { "when": { "from": "regular", "to": "system"  }, "add": ["convert_to_sealed","remove_fe_tanks"] },
    { "when": { "from": "regular", "to": "combi"   }, "add": ["convert_to_sealed","remove_fe_tanks","dhw_now_mains","remove_shower_pumps","no_replacement_cyl"] },
    { "when": { "from": "system",  "to": "combi"   }, "add": ["dhw_now_mains","remove_shower_pumps","no_replacement_cyl"] },
    { "when": { "from": "system",  "to": "regular" }, "add": ["keep_open_vent"] },
    { "when": { "from": "system",  "to": "system"  }, "add": [] },
    { "when": { "from": "combi",   "to": "regular" }, "add": ["keep_open_vent"] },
    { "when": { "from": "combi",   "to": "system"  }, "add": [] },
    { "when": { "from": "combi",   "to": "combi"   }, "add": [] }
  ],
  "cylinder_transitions": [
    { "when": { "from": "vented",   "to": "vented"   }, "add": ["retain_vented_cyl"] },
    { "when": { "from": "vented",   "to": "unvented" }, "add": ["remove_vented_cyl","g3_req","install_unvented"] },
    { "when": { "from": "vented",   "to": "none"     }, "add": ["remove_vented_cyl","no_replacement_cyl"] },
    { "when": { "from": "unvented", "to": "unvented" }, "add": ["retain_unvented"] },
    { "when": { "from": "unvented", "to": "vented"   }, "add": ["keep_open_vent"] },
    { "when": { "from": "unvented", "to": "none"     }, "add": ["no_replacement_cyl"] },
    { "when": { "from": "none",     "to": "vented"   }, "add": ["keep_open_vent"] },
    { "when": { "from": "none",     "to": "unvented" }, "add": ["g3_req","install_unvented"] }
  ],
  "flue_transitions": [
    { "when": { "from": "balanced",   "to": "fanned_horizontal" }, "add": ["fanned_horizontal","terminal_clearances"] },
    { "when": { "from": "open",       "to": "fanned_horizontal" }, "add": ["fanned_horizontal","terminal_clearances"] },
    { "when": { "from": "horizontal", "to": "fanned_horizontal" }, "add": ["fanned_horizontal","terminal_clearances"] },
    { "when": { "from": "any",        "to": "fanned_vertical"   }, "add": ["fanned_vertical","terminal_clearances"] }
  ],
  "flue_overrides": [
    { "flag": "plume_required",     "when_to": ["fanned_horizontal","fanned_vertical"], "add": ["plume_kit"] },
    { "flag": "plume_not_required", "when_to": ["fanned_horizontal","fanned_vertical"], "add": ["no_plume_needed"] }
  ],
  "context_flags": [
    { "flag": "shower_pump_present", "on_boiler_to": ["combi","unvented"], "add": ["remove_shower_pumps"] }
  ],

  /* NEW: section rules â†’ produce codes/text automatically.
     Each rule adds item codes from sections_source.txt OR note keys from notes_lookup.json */
  "sections": {
    "Needs": [
      { "when_flags": ["low_mains_pressure"],                 "add_codes": ["NE01"] },
      { "when_flags": ["slow_hotwater_to_distant_outlets"],   "add_codes": ["NE02"] },
      { "when_flags": ["need_space"],                          "add_codes": ["NE03"] },
      { "when_flags": ["reduce_running_costs"],                "add_codes": ["NE04"] },
      { "when_flags": ["pref_simple_controls"],                "add_codes": ["NE05"] },
      { "when_flags": ["noise_sensitive"],                     "add_codes": ["NE06"] },
      { "when_flags": ["future_ready"],                        "add_codes": ["NE07"] }
    ],

    "Working at heights": [
      { "when_flags": ["loft_install"],                        "add_codes": ["WAH04A","WAH54"] },
      { "when_flags": ["loft_unboarded"],                      "add_codes": ["WAH04B","WAH54"] },
      { "when_flags": ["flat_roof_work"],                      "add_codes": ["WAH52"] },
      { "when_flags": ["two_storeys_or_45deg"],                "add_codes": ["WAH51"] },
      { "when_flags": ["scaffold_required_standard"],          "add_codes": ["WAH02A"] },
      { "when_flags": ["scaffold_required_bridging"],          "add_codes": ["WAH02B"] },
      { "when_flags": ["scaffold_required_cantilever"],        "add_codes": ["WAH02C"] }
    ],

    "System characteristics": [
      /* use transition notes already produced PLUS these cues: */
      { "when_flags": ["microbore"],                           "add_text_keys": ["SC54"] },
      { "when_flags": ["one_pipe"],                            "add_text_keys": ["SC55"] },
      { "when_flags": ["galv_or_steel"],                       "add_text_keys": ["SC56"] },
      { "when_flags": ["loft_install"],                        "add_text_keys": ["SC59"] },
      { "when_flags": ["external_condensate"],                 "add_text_keys": ["SC60"] }
    ],

    "Arse_cover_notes": [
      { "when_to_boiler": ["system","combi"],                  "add_codes": ["ARS01","ARS02","ARS03","ARS04","ARS05","ARS06","ARS07"] },
      { "when_to_boiler": ["combi"],                           "add_codes": ["ARS08","ARS09","ARS10","ARS11","ARS12","ARS13","ARS14"] },
      { "when_to_cylinder": ["unvented"],                      "add_codes": ["ARS16","ARS17"] },
      { "when_flags": ["external_condensate"],                 "add_codes": ["ARS20","ARS23"] },
      { "when_flags": ["loft_install"],                        "add_codes": ["ARS33","ARS34"] }
    ],

    "Components that require assistance": [
      { "when_flags": ["cyl_remove"],                          "add_codes": ["CS01"] },
      { "when_flags": ["cyl_replace"],                         "add_codes": ["CS02"] },
      { "when_flags": ["cws_tank_remove"],                     "add_codes": ["CS03"] },
      { "when_flags": ["two_person_lift"],                     "add_codes": ["CS04"] }
    ],

    "Restrictions to work": [
      { "when_flags": ["no_loft_access"],                      "add_codes": ["SR01"] },
      { "when_flags": ["restricted_clearance"],                "add_codes": ["SR02"] },
      { "when_flags": ["permit_parking"],                      "add_codes": ["SR03"] },
      { "when_flags": ["restricted_hours"],                    "add_codes": ["SR04"] },
      { "when_flags": ["vulnerable_occupant"],                 "add_codes": ["SR06"] },
      { "when_flags": ["septic_tank"],                         "add_codes": ["SR08"] },
      { "when_flags": ["listed_building"],                     "add_codes": ["SR09","SR10"] },
      { "when_flags": ["flat_management_permission"],          "add_codes": ["SR11"] }
    ],

    "External hazards": [
      { "when_flags": ["asbestos_suspected"],                  "add_codes": ["EH01","ASB50"] },
      { "when_flags": ["fragile_roof"],                        "add_codes": ["EH02"] },
      { "when_flags": ["flood_risk"],                          "add_codes": ["EH03"] },
      { "when_flags": ["wasps"],                               "add_codes": ["EH04"] },
      { "when_flags": ["bees"],                                "add_codes": ["EH05"] },
      { "when_flags": ["no_lighting"],                         "add_codes": ["EH06"] },
      { "when_flags": ["pet_mess"],                            "add_codes": ["EH07"] },
      { "when_flags": ["dogs_present"],                        "add_codes": ["EH08"] },
      { "when_flags": ["overhead_cables"],                     "add_codes": ["HAZ50"] }
    ],

    "Delivery notes": [
      { "when_flags": ["pref_am"],                             "add_codes": ["DL01"] },
      { "when_flags": ["pref_pm"],                             "add_codes": ["DL02"] },
      { "when_flags": ["large_vehicle_ok"],                    "add_codes": ["DL03"] },
      { "when_flags": ["large_vehicle_restricted"],            "add_codes": ["DL04"] },
      { "when_flags": ["deliver_to_garage"],                   "add_codes": ["DL05"] },
      { "when_flags": ["deliver_inside"],                      "add_codes": ["DL06"] },
      { "when_flags": ["call_ahead"],                          "add_codes": ["DL07"] },
      { "when_flags": ["two_person_lift"],                     "add_codes": ["DL08"] }
    ],

    "Office notes": [
      { "when_flags": ["direct_labour"],                       "add_codes": ["OA01"] },
      { "when_flags": ["asbestos_removal_arrange"],            "add_codes": ["OA02"] },
      { "when_flags": ["specialist_builder"],                  "add_codes": ["OA03"] },
      { "when_flags": ["scaffold_needed"],                     "add_codes": ["OA04"] },
      { "when_flags": ["two_person_lift"],                     "add_codes": ["OA05"] }
    ],

    "Boiler and controls": [
      /* purely location/type/controls summaries; wiring never mentioned */
      { "when_flags": ["loc_kitchen"],                         "add_codes": ["BLC01"] },
      { "when_flags": ["loc_kitchen_cupboard"],                "add_codes": ["BLC02"] },
      { "when_flags": ["loc_utility"],                         "add_codes": ["BLC04"] },
      { "when_flags": ["loc_loft"],                            "add_codes": ["BLC05"] },
      { "when_flags": ["loc_garage"],                          "add_codes": ["BLC06"] },
      { "when_flags": ["loc_airing"],                          "add_codes": ["BLC08"] },
      { "when_to_boiler": ["regular"],                         "add_codes": ["BT01"] },
      { "when_to_boiler": ["system"],                          "add_codes": ["BT02"] },
      { "when_to_boiler": ["combi"],                           "add_codes": ["BT03"] },
      { "when_flags": ["ctrl_hive"],                           "add_codes": ["UC01"] },
      { "when_flags": ["ctrl_hive_mini"],                      "add_codes": ["UC02"] },
      { "when_flags": ["ctrl_prog_stat"],                      "add_codes": ["UC03"] },
      { "when_flags": ["ctrl_wireless_stat"],                  "add_codes": ["UC05"] }
    ],

    "Flue": [
      /* add-on logic beyond transition text */
      { "when_flags": ["use_same_hole_minor"],                 "add_codes": ["FN01"] },
      { "when_flags": ["new_hole_same_wall"],                  "add_codes": ["FN02"] },
      { "when_flags": ["new_hole_alt_wall"],                   "add_codes": ["FN03"] },
      { "when_flags": ["terminal_guard"],                      "add_codes": ["FN11"] },
      { "when_flags": ["boundary_close"],                     "add_codes": ["FLU52"] }
    ],

    "Pipework": [
      { "when_flags": ["upgrade_gas_22mm"],                    "add_codes": ["GR01","GAS51"] },
      { "when_flags": ["long_run_capacity"],                   "add_codes": ["GR10"] },
      { "when_flags": ["cond_internal_trap_add"],              "add_codes": ["CD02"] },
      { "when_flags": ["cond_external"],                       "add_codes": ["CD03"] },
      { "when_flags": ["cond_pump"],                           "add_codes": ["CD05"] },
      { "when_flags": ["cond_neutraliser"],                    "add_codes": ["CD11"] },
      { "when_flags": ["increase_mains_flow"],                 "add_codes": ["WS01"] },
      { "when_flags": ["scale_filter"],                        "add_codes": ["WS04"] },
      { "when_flags": ["discharge_tundish_visible"],           "add_codes": ["DS02"] }
    ],

    "Disruption / Cleaning / Filtration": [
      { "when_flags": ["powerflush"],                          "add_codes": ["PF01","PF53"] },
      { "when_flags": ["chem_clean"],                          "add_codes": ["PF02"] },
      { "when_flags": ["mag_filter"],                          "add_codes": ["PF03"] },
      { "when_to_boiler": ["combi"],                           "add_codes": ["CE50","CE51","CE52"] },
      { "when_to_boiler": ["system","combi"],                  "add_codes": ["CE53"] },
      { "when_flags": ["external_condensate"],                 "add_codes": ["CE55"] }
    ],

    "Radiators": [
      { "when_flags": ["replace_rads"],                        "add_codes": ["RD01"] },
      { "when_flags": ["fit_trvs"],                            "add_codes": ["RD03"] },
      { "when_flags": ["balance_on_completion"],               "add_codes": ["RD04"] }
    ],

    "Customer actions": [
      { "when_flags": ["clear_work_areas"],                    "add_codes": ["CA01"] },
      { "when_flags": ["permissions_required"],                "add_codes": ["CA02"] },
      { "when_flags": ["pets_present"],                        "add_codes": ["CA03"] },
      { "when_flags": ["remove_cupboard_customer"],            "add_codes": ["CA04"] },
      { "when_flags": ["rebuild_cupboard_customer"],           "add_codes": ["CA05"] },
      { "when_flags": ["customer_supply_items"],               "add_codes": ["CA07"] }
    ]
  },

  "essentialiser": {
    "max_per_section": 6,
    "priority": {
      "System characteristics (new)": ["convert_to_sealed","keep_open_vent","remove_fe_tanks","dhw_now_mains","remove_shower_pumps","g3_req","install_unvented","no_replacement_cyl"],
      "Flue": ["fanned_horizontal","fanned_vertical","terminal_clearances","plume_kit","no_plume_needed"]
    }
  }
}
